const fs = require('fs');
const path = require('path');
const yauzl = require('yauzl');
const yazl = require('yazl');

const srcVsix = path.resolve('EmmyLua-Rhea-0.9.29-local-activatefix.vsix');
const outVsix = path.resolve('EmmyLua-Rhea-0.9.29-local-activatefix-withnode.vsix');
const nodeModulesDir = path.resolve('node_modules');

function walkFiles(dir, baseDir, out = []) {
  const entries = fs.readdirSync(dir, { withFileTypes: true });
  for (const e of entries) {
    const abs = path.join(dir, e.name);
    if (e.isDirectory()) {
      walkFiles(abs, baseDir, out);
    } else if (e.isFile()) {
      const rel = path.relative(baseDir, abs).split(path.sep).join('/');
      out.push({ abs, rel });
    }
  }
  return out;
}

function openZip(zipPath) {
  return new Promise((resolve, reject) => {
    yauzl.open(zipPath, { lazyEntries: true }, (err, zip) => err ? reject(err) : resolve(zip));
  });
}

function openReadStream(zip, entry) {
  return new Promise((resolve, reject) => {
    zip.openReadStream(entry, (err, stream) => err ? reject(err) : resolve(stream));
  });
}

(async function main() {
  if (!fs.existsSync(srcVsix)) throw new Error(`Missing source vsix: ${srcVsix}`);
  if (!fs.existsSync(nodeModulesDir)) throw new Error(`Missing node_modules: ${nodeModulesDir}`);

  const zipIn = await openZip(srcVsix);
  const zipOut = new yazl.ZipFile();
  const outStream = fs.createWriteStream(outVsix);
  zipOut.outputStream.pipe(outStream);

  const existing = new Set();
  let copied = 0;

  zipIn.readEntry();
  zipIn.on('entry', async (entry) => {
    try {
      existing.add(entry.fileName);
      const rs = await openReadStream(zipIn, entry);
      const mode = (entry.externalFileAttributes >>> 16) || 0o100644;
      const mtime = entry.getLastModDate ? entry.getLastModDate() : new Date();
      zipOut.addReadStream(rs, entry.fileName, { mode, mtime });
      copied++;
      zipIn.readEntry();
    } catch (e) {
      console.error(e);
      process.exit(1);
    }
  });

  zipIn.on('end', () => {
    const files = walkFiles(nodeModulesDir, nodeModulesDir);
    let added = 0;
    for (const f of files) {
      const target = `extension/node_modules/${f.rel}`;
      if (!existing.has(target)) {
        zipOut.addFile(f.abs, target);
        added++;
      }
    }

    zipOut.end();
    outStream.on('close', () => {
      console.log(JSON.stringify({ copiedFromBase: copied, addedNodeModuleFiles: added, outVsix }, null, 2));
    });
  });
})();
